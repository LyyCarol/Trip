----------------------------------------------------------------
--comment auto generated by zeus
--名称 ：adm_ins_abt_flt_us_tying_rate
--功能描述 ：机票美国险-AB测试-保险转化数据（实验周期：20230822-1006）
--输入表 ： 
--输出表 ： 
--创建人：lyy林弋渝
--创建时间：2023-9-1
--运行类型 ： 
--注意事项 ：
--说明 ：
--修改历史 ：修改人    / 修改时间  / 主要改动说明
--      1. lyy林弋渝 / 2023-9-1 / 创建流程
--      2. lyy林弋渝 / 2023-10-18 / 更新结束日期，停止实验
--      3. lyy林弋渝 / 2023-10-19 / 添加字段primorderflightway
----------------------------------------------------------------

use dw_finance_ibuins_db;
insert overwrite table dw_finance_ibuins_db.adm_ins_abt_flt_us_tying_rate
partition (d = '${zdt.addDay(0).format("yyyy-MM-dd")}')

select
  a.d as date
  ,a.abversion
  ,a.channeltype
  ,b.flight_pair
  ,count(distinct if(b.primorderdcountryname = '美国',b.vid,null)) as ord_us_uv
  ,count(distinct if(b.primorderdcountryname = '美国',b.primaryorderid_fill,null)) as ord_us_cnt
  ,count(distinct if(b.primorderdcountryname = '美国' and c.vid is not null,b.primaryorderid_fill,null)) as ins_show_cnt
  ,count(distinct if(b.primorderdcountryname = '美国',d.primaryorderid_fill,null)) as ins_ord_cnt
  ,ifnull(sum(d.policyno_cnt),0) as policyno_cnt
  ,ifnull(sum(d.premium_usd),0) as premium_usd
  ,ifnull(sum(d.commission_usd),0) as commission_usd
  ,ifnull(sum(d.servicefee_usd),0) as servicefee_usd
  ,b.primorderflightway
from 
(
  select d, experiment, abversion, vid, 'online' as channeltype
  from dw_engdb.engabversionsplitinfo_online
  where experiment like '%230818_IBU_usol%'
  and d >= '2023-08-22' and d <= '2023-10-06'
  group by 1,2,3,4,5
  union all
  select d, experiment, abversion, vid, 'h5' as channeltype
  from dw_engdb.engabversionsplitinfo_h5
  where experiment like '%230818_IBU_ush5%'
  and d >= '2023-08-22' and d <= '2023-10-06'
  group by 1,2,3,4,5
) a
inner join
(
  select primaryorderid_fill, primorderorderdate, vid, primorderdcountryname, channeltype, region
    ,case when primorderdcountryname = '美国' and primorderacountryname = '美国' then '美国境内-境内'
          when primorderdcountryname = '美国' and primorderacountryname <> '美国' then '美国境内-境外'
          else null end as flight_pair
  	,primorderflightway
  	,sum(ord_quantity) as ord_quantity
  from dw_pay_ibu.edw_payment_fact_ibu_fltorder_snap
  where substr(primorderorderdate,1,10) between '2023-08-22' and '2023-10-06'
  and region = 'us'
  and primorderdcountryname = '美国'
  group by 1,2,3,4,5,6,7,8
) b
on substr(a.d,1,10) = substr(b.primorderorderdate,1,10) and a.channeltype = b.channeltype and a.vid = b.vid and b.flight_pair is not null
left outer join
(select d,uid,region,channeltype,vid
	  from
	    (
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_load 
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_insurance_load','ibu_flt_h5_insurance_load','ibu_flt_online_insurance_load') and typeid is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
	    	union all
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_show
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_travelinsurance_show','ibu_flt_h5_travelinsurance_show','ibu_flt_online_travelinsurance_show') and insurancetype is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
            union all
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_select_exit
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_travelinsurance_select_exit','ibu_flt_h5_travelinsurance_select_exit','ibu_flt_online_travelinsurance_select_exit') and insurancetype is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
	    ) a
	  group by 1,2,3,4,5
) c
on lower(trim(b.vid)) = lower(trim(c.vid)) and b.region = c.region and b.channeltype = c.channeltype and substr(b.primorderorderdate,1,10) = c.d
left outer join
(
	select 
		a.primaryorderid_fill
		,a.productname
		,count(distinct a.policyno) as policyno_cnt
		,sum(a.premium) as premium
		,sum(a.commission) as commission
		,sum(a.servicefee) as servicefee
		,sum(a.premium * c.exchangerate) as premium_usd
		,sum(a.commission * c.exchangerate) as commission_usd
		,sum(a.servicefee * c.exchangerate) as servicefee_usd
	from
	(
		select orderid,primaryorderid_fill,policyno,currency,transtime,premium,commission,servicefee,productname
		from dw_finance_ibuins_db.edw_ins_transdata_record
		where d = '${zdt.addDay(0).format("yyyy-MM-dd")}' and is_refund = 0 and booktypename = '主流程' and productname like '%美国%'
	) a
	left outer join
		dw_finance_ibuins_db.dim_ibuins_currency_usd_rate c
	on a.currency = c.currency and substr(a.transtime,1,10) = c.date
	group by a.primaryorderid_fill, a.productname
) d
on b.primaryorderid_fill = d.primaryorderid_fill

group by a.d,a.abversion,a.channeltype,b.flight_pair,b.primorderflightway

union all

select
  a.d as date
  ,a.abversion
  ,a.channeltype
  ,b.flight_pair
  ,count(distinct if(b.primorderdcountryname = '美国',b.cid,null)) as ord_us_uv
  ,count(distinct if(b.primorderdcountryname = '美国',b.primaryorderid_fill,null)) as ord_us_cnt
  ,count(distinct if(b.primorderdcountryname = '美国' and c.cid is not null,b.primaryorderid_fill,null)) as ins_show_cnt
  ,count(distinct if(b.primorderdcountryname = '美国',d.primaryorderid_fill,null)) as ins_ord_cnt
  ,ifnull(sum(d.policyno_cnt),0) as policyno_cnt
  ,ifnull(sum(d.premium_usd),0) as premium_usd
  ,ifnull(sum(d.commission_usd),0) as commission_usd
  ,ifnull(sum(d.servicefee_usd),0) as servicefee_usd
  ,b.primorderflightway
from 
(
  select d, experiment, abversion, clientcode as cid, 'app' as channeltype
  from dw_engdb.engabversionsplitinfo_app
  where experiment like '%230630_IBU_usbx%'
  and d >= '2023-08-22' and d <= '2023-10-06'
  group by 1,2,3,4,5
) a
left outer join
(
  select primaryorderid_fill, primorderorderdate, primorderdcountryname, channeltype, cid, region
    ,case when primorderdcountryname = '美国' and primorderacountryname = '美国' then '美国境内-境内'
          when primorderdcountryname = '美国' and primorderacountryname <> '美国' then '美国境内-境外'
          else null end as flight_pair
  	,primorderflightway
  	,sum(ord_quantity) as ord_quantity
  from dw_pay_ibu.edw_payment_fact_ibu_fltorder_snap
  where substr(primorderorderdate,1,10) between '2023-08-22' and '2023-10-06'
  and region = 'us'
  and primorderdcountryname = '美国'
  group by 1,2,3,4,5,6,7,8
) b
on substr(a.d,1,10) = substr(b.primorderorderdate,1,10) and a.channeltype = b.channeltype and a.cid = b.cid and b.flight_pair is not null
left outer join
(select d,uid,region,channeltype,cid
	  from
	    (
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_load 
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_insurance_load','ibu_flt_h5_insurance_load','ibu_flt_online_insurance_load') and typeid is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
	    	union all
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_show
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_travelinsurance_show','ibu_flt_h5_travelinsurance_show','ibu_flt_online_travelinsurance_show') and insurancetype is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
            union all
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_select_exit
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_travelinsurance_select_exit','ibu_flt_h5_travelinsurance_select_exit','ibu_flt_online_travelinsurance_select_exit') and insurancetype is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
	    ) a
	  group by 1,2,3,4,5
) c
on lower(trim(b.cid)) = lower(trim(c.cid)) and b.region = c.region and b.channeltype = c.channeltype and substr(b.primorderorderdate,1,10) = c.d
left outer join
(
	select 
		a.primaryorderid_fill
		,a.productname
		,count(distinct a.policyno) as policyno_cnt
		,sum(a.premium) as premium
		,sum(a.commission) as commission
		,sum(a.servicefee) as servicefee
		,sum(a.premium * c.exchangerate) as premium_usd
		,sum(a.commission * c.exchangerate) as commission_usd
		,sum(a.servicefee * c.exchangerate) as servicefee_usd
	from
	(
		select orderid,primaryorderid_fill,policyno,currency,transtime,premium,commission,servicefee,productname
		from dw_finance_ibuins_db.edw_ins_transdata_record
		where d = '${zdt.addDay(0).format("yyyy-MM-dd")}' and is_refund = 0 and booktypename = '主流程' and productname like '%美国%'
	) a
	left outer join
		dw_finance_ibuins_db.dim_ibuins_currency_usd_rate c
	on a.currency = c.currency and substr(a.transtime,1,10) = c.date
	group by a.primaryorderid_fill, a.productname
) d
on b.primaryorderid_fill = d.primaryorderid_fill

group by a.d,a.abversion,a.channeltype,b.flight_pair,b.primorderflightway

union all

select
  a.d as date
  ,a.abversion
  ,'整体' as channeltype
  ,b.flight_pair
  ,count(distinct if(b.primorderdcountryname = '美国',b.vid,null)) as ord_us_uv
  ,count(distinct if(b.primorderdcountryname = '美国',b.primaryorderid_fill,null)) as ord_us_cnt
  ,count(distinct if(b.primorderdcountryname = '美国' and c.vid is not null,b.primaryorderid_fill,null)) as ins_show_cnt
  ,count(distinct if(b.primorderdcountryname = '美国',d.primaryorderid_fill,null)) as ins_ord_cnt
  ,ifnull(sum(d.policyno_cnt),0) as policyno_cnt
  ,ifnull(sum(d.premium_usd),0) as premium_usd
  ,ifnull(sum(d.commission_usd),0) as commission_usd
  ,ifnull(sum(d.servicefee_usd),0) as servicefee_usd
  ,b.primorderflightway
from 
(
  select d, experiment, abversion, vid, 'online' as channeltype
  from dw_engdb.engabversionsplitinfo_online
  where experiment like '%230818_IBU_usol%'
  and d >= '2023-08-22' and d <= '2023-10-06'
  group by 1,2,3,4,5
  union all
  select d, experiment, abversion, vid, 'h5' as channeltype
  from dw_engdb.engabversionsplitinfo_h5
  where experiment like '%230818_IBU_ush5%'
  and d >= '2023-08-22' and d <= '2023-10-06'
  group by 1,2,3,4,5
) a
inner join
(
  select primaryorderid_fill, primorderorderdate, vid, primorderdcountryname, channeltype, region
    ,case when primorderdcountryname = '美国' and primorderacountryname = '美国' then '美国境内-境内'
          when primorderdcountryname = '美国' and primorderacountryname <> '美国' then '美国境内-境外'
          else null end as flight_pair
  	,primorderflightway
  	,sum(ord_quantity) as ord_quantity
  from dw_pay_ibu.edw_payment_fact_ibu_fltorder_snap
  where substr(primorderorderdate,1,10) between '2023-08-22' and '2023-10-06'
  and region = 'us'
  and primorderdcountryname = '美国'
  group by 1,2,3,4,5,6,7,8
) b
on substr(a.d,1,10) = substr(b.primorderorderdate,1,10) and a.channeltype = b.channeltype and a.vid = b.vid and b.flight_pair is not null
left outer join
(select d,uid,region,channeltype,vid
	  from
	    (
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_load 
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_insurance_load','ibu_flt_h5_insurance_load','ibu_flt_online_insurance_load') and typeid is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
	    	union all
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_show
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_travelinsurance_show','ibu_flt_h5_travelinsurance_show','ibu_flt_online_travelinsurance_show') and insurancetype is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
            union all
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_select_exit
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_travelinsurance_select_exit','ibu_flt_h5_travelinsurance_select_exit','ibu_flt_online_travelinsurance_select_exit') and insurancetype is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
	    ) a
	  group by 1,2,3,4,5
) c
on lower(trim(b.vid)) = lower(trim(c.vid)) and b.region = c.region and b.channeltype = c.channeltype and substr(b.primorderorderdate,1,10) = c.d
left outer join
(
	select 
		a.primaryorderid_fill
		,a.productname
		,count(distinct a.policyno) as policyno_cnt
		,sum(a.premium) as premium
		,sum(a.commission) as commission
		,sum(a.servicefee) as servicefee
		,sum(a.premium * c.exchangerate) as premium_usd
		,sum(a.commission * c.exchangerate) as commission_usd
		,sum(a.servicefee * c.exchangerate) as servicefee_usd
	from
	(
		select orderid,primaryorderid_fill,policyno,currency,transtime,premium,commission,servicefee,productname
		from dw_finance_ibuins_db.edw_ins_transdata_record
		where d = '${zdt.addDay(0).format("yyyy-MM-dd")}' and is_refund = 0 and booktypename = '主流程' and productname like '%美国%'
	) a
	left outer join
		dw_finance_ibuins_db.dim_ibuins_currency_usd_rate c
	on a.currency = c.currency and substr(a.transtime,1,10) = c.date
	group by a.primaryorderid_fill, a.productname
) d
on b.primaryorderid_fill = d.primaryorderid_fill

group by a.d,a.abversion,a.channeltype,b.flight_pair,b.primorderflightway

union all

select
  a.d as date
  ,a.abversion
  ,'整体' as channeltype
  ,b.flight_pair
  ,count(distinct if(b.primorderdcountryname = '美国',b.cid,null)) as ord_us_uv
  ,count(distinct if(b.primorderdcountryname = '美国',b.primaryorderid_fill,null)) as ord_us_cnt
  ,count(distinct if(b.primorderdcountryname = '美国' and c.cid is not null,b.primaryorderid_fill,null)) as ins_show_cnt
  ,count(distinct if(b.primorderdcountryname = '美国',d.primaryorderid_fill,null)) as ins_ord_cnt
  ,ifnull(sum(d.policyno_cnt),0) as policyno_cnt
  ,ifnull(sum(d.premium_usd),0) as premium_usd
  ,ifnull(sum(d.commission_usd),0) as commission_usd
  ,ifnull(sum(d.servicefee_usd),0) as servicefee_usd
  ,b.primorderflightway
from 
(
  select d, experiment, abversion, clientcode as cid, 'app' as channeltype
  from dw_engdb.engabversionsplitinfo_app
  where experiment like '%230630_IBU_usbx%'
  and d >= '2023-08-22' and d <= '2023-10-06'
  group by 1,2,3,4,5
) a
left outer join
(
  select primaryorderid_fill, primorderorderdate, primorderdcountryname, channeltype, cid, region
    ,case when primorderdcountryname = '美国' and primorderacountryname = '美国' then '美国境内-境内'
          when primorderdcountryname = '美国' and primorderacountryname <> '美国' then '美国境内-境外'
          else null end as flight_pair
  	,primorderflightway
  	,sum(ord_quantity) as ord_quantity
  from dw_pay_ibu.edw_payment_fact_ibu_fltorder_snap
  where substr(primorderorderdate,1,10) between '2023-08-22' and '2023-10-06'
  and region = 'us'
  and primorderdcountryname = '美国'
  group by 1,2,3,4,5,6,7,8
) b
on substr(a.d,1,10) = substr(b.primorderorderdate,1,10) and a.channeltype = b.channeltype and a.cid = b.cid and b.flight_pair is not null
left outer join
(select d,uid,region,channeltype,cid
	  from
	    (
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_load 
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_insurance_load','ibu_flt_h5_insurance_load','ibu_flt_online_insurance_load') and typeid is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
	    	union all
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_show
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_travelinsurance_show','ibu_flt_h5_travelinsurance_show','ibu_flt_online_travelinsurance_show') and insurancetype is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
            union all
	    	select d,coalesce(login_uid,uid) as uid,region,split(key,'_')[2] as channeltype, vid, clientid as cid
	    	from dw_finance_ibuins_db.edw_ins_user_custom_flt_insurance_select_exit
	    	where d >= '2023-08-22' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' 
	    	and key in ('ibu_flt_app_travelinsurance_select_exit','ibu_flt_h5_travelinsurance_select_exit','ibu_flt_online_travelinsurance_select_exit') and insurancetype is not null 
	    	and region = 'us'
	    	group by d,coalesce(login_uid,uid),region,split(key,'_')[2],vid,clientid
	    ) a
	  group by 1,2,3,4,5
) c
on lower(trim(b.cid)) = lower(trim(c.cid)) and b.region = c.region and b.channeltype = c.channeltype and substr(b.primorderorderdate,1,10) = c.d
left outer join
(
	select 
		a.primaryorderid_fill
		,a.productname
		,count(distinct a.policyno) as policyno_cnt
		,sum(a.premium) as premium
		,sum(a.commission) as commission
		,sum(a.servicefee) as servicefee
		,sum(a.premium * c.exchangerate) as premium_usd
		,sum(a.commission * c.exchangerate) as commission_usd
		,sum(a.servicefee * c.exchangerate) as servicefee_usd
	from
	(
		select orderid,primaryorderid_fill,policyno,currency,transtime,premium,commission,servicefee,productname
		from dw_finance_ibuins_db.edw_ins_transdata_record
		where d = '${zdt.addDay(0).format("yyyy-MM-dd")}' and is_refund = 0 and booktypename = '主流程' and productname like '%美国%'
	) a
	left outer join
		dw_finance_ibuins_db.dim_ibuins_currency_usd_rate c
	on a.currency = c.currency and substr(a.transtime,1,10) = c.date
	group by a.primaryorderid_fill, a.productname
) d
on b.primaryorderid_fill = d.primaryorderid_fill

group by a.d,a.abversion,a.channeltype,b.flight_pair,b.primorderflightway
