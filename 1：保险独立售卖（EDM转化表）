----------------------------------------------------------------
--comment auto generated by zeus
--名称 ：adm_ins_ind_mkt_insemail_send_report_fltprimaryorder_supbook
--功能描述 ：
--输入表 ： 
--输出表 ： 
--创建人：lyy林弋渝
--创建时间：2023-9-15
--运行类型 ： 
--注意事项 ：
--说明 ：
--修改历史 ：修改人    / 修改时间  / 主要改动说明
--      1. lyy林弋渝 / 2023-9-15 / 创建流程
--      2. lyy林弋渝 / 2023-11-6 / 更新createorder_num和order_num的字段统计逻辑，原逻辑中当一个uid创>=2个订单时只会被记成1，新逻辑中去掉对uid的distinct
----------------------------------------------------------------

use dw_finance_ibuins_db;
insert overwrite table dw_finance_ibuins_db.adm_ins_ind_mkt_insemail_send_report_fltprimaryorder_supbook
partition (d,region,prdtype)
select 
	taskId
	,locale
	,group_type
	,count(distinct uid) as upload_num
	,count(distinct case when sendtime is not null then uid else null end) as send_num
	,count(distinct case when send_statuscode = '20000' or firstopentime is not null then uid else null end) as deliver_num
	,count(distinct case when firstopentime is not null then uid else null end) as open_num
	,count(distinct case when orderpage_clicktime is not null then uid else null end) as click_num
	,count(case when createordertime is not null then uid else null end) as createorder_num
	,count(case when ordertime is not null then uid else null end) as order_num
	,sum(coalesce(policyno_cnt,0)) as policyno_cnt
	,sum(coalesce(premium_usd,0)) as premium_usd
	,sum(coalesce(commission_usd,0)) as commission_usd
	,d
	,region
  	,case when prdtype = 'F' then '机票'
    	  when prdtype = 'X' then '机酒'
          when prdtype = 'H' then '酒店'
          when prdtype = 'INS' then '独立售卖'
          when prdtype = 'C' then '租车'
          when prdtype = 'T' then '国内火车票'
          else null end as prdtype
from 
(
  select * from dw_finance_ibuins_db.edw_ins_ind_mkt_insemail_send_status_fltprimaryorder_supbook
  where d >= '2023-09-12' and d <= '${zdt.addDay(-1).format("yyyy-MM-dd")}'
  and d not between '2023-10-13' and '2023-11-02'
) a
group by taskId,locale,group_type,d,region,prdtype
