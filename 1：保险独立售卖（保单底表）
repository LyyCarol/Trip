----------------------------------------------------------------
--comment auto generated by zeus
--名称 ：海外保险-独立售卖保单数据
--功能描述 ：
--输入表 ： 
--输出表 ： 
--创建人：lyy林弋渝
--创建时间：2023-7-21
--运行类型 ： 
--注意事项 ：
--说明 ：
--修改历史 ：修改人    / 修改时间  / 主要改动说明
--      1. lyy林弋渝 / 2023-7-21 / 创建流程
--      2. lyy林弋渝 / 2023-8-6 / 添加字段pay_premium(保费+税费)
--      3. lyy林弋渝 / 2023-8-30 / 添加字段bcp
----------------------------------------------------------------

with policy_insure as
(
select
  b.apply_id
  ,b.trans_id
  ,a.uid
  ,a.order_id
  ,107 as settlementitemid
  ,replace(lower(e.locale),'_','-') as locale
  ,right(lower(e.locale),2) as region
  ,case when b.policystatus = 1 then 0
        else 2 end as insurancetype 				-- 保单类型(0:出保;1:退保;2:处理中)
  ,case when b.policystatus = 1 then '出保'
        else '处理中' end as insurancetype_name
  ,b.policy_no as policyno
  ,b.company_id as companyid
  ,h.companyname
  ,b.product_code as productcode
  ,h.productname
  ,a.pay_currency as currency
  ,b.ins_premium as premium
  ,coalesce(b.pay_levy,0) as levy
  ,coalesce(c.commission,0) as commission
  ,coalesce(c.servicefee,0) as servicefee
  ,b.trans_time as transtime
  ,b.effective_time as effectivetime
  ,b.expiry_time as expirytime
  ,b.url as policy_url
  ,get_json_object(b.extend_info,'$.content[0].departure') as departure
  ,get_json_object(b.extend_info,'$.content[0].departureTime') as departuretime
  ,get_json_object(b.extend_info,'$.content[0].arrivalTime') as arrivaltime
  ,a.ordertime 										-- 下单时间
  ,NULL as etd 										-- 订单结算时间
  ,b.policy_datachange_createtime
  ,b.policy_datachange_lasttime
  ,b.ins_premium + coalesce(b.pay_levy,0) as pay_premium
  ,case when g.bcp is not null then g.bcp
        when g.bcp is null and substr(a.ordertime,1,10) <= '2023-08-17' then '1-1-1'
        when g.order_id in ('23879232811','23879236533') then '2-1-4' -- 订详页入口bcp
        else null
        end as bcp
from
( -- 投保表，仅含交易流水号
  select distinct
    apply_id, trans_id, company_id, product_code, status as policystatus, 
    case when status = 1 then '出保成功'
         when status = 2 then '出保失败'
         when status = 3 then '出保异常'
         else null end as policystatus_name, 
    pay_premium, pay_currency, pay_levy, ins_premium, ins_currency, exchange_rate, effective_time, expiry_time, reference_id, provider_trans_id, policy_no, url, trans_time, company_city_code, sales_terms_details_url, extend_info, datachange_createtime as policy_datachange_createtime, datachange_lasttime as policy_datachange_lasttime
  from ods_ccardibuinsprocesssindb.ods_sale_apply_info
  where d = '${zdt.addDay(0).format("yyyy-MM-dd")}'
  and substr(trans_time,1,10) >= '2023-07-17' and substr(trans_time,1,10) <= '${zdt.addDay(-1).format("yyyy-MM-dd")}'
) b
left outer join dw_finance_ibuins_db.dim_product h
on b.product_code = h.productcode
left outer join
( -- 订单表，含交易流水号和订单号
  select distinct
  	id, uid, order_id, trans_id, status as orderstatus, pay_amount, pay_currency, confirm_time as ordertime, local_confirm_time as local_ordertime, 
   	datachange_lasttime as order_datachange_lasttime, datachange_createtime as order_datachange_createtime
  from ods_ccardibuinsprocesssindb.ods_sale_order_info
  where d = '${zdt.addDay(0).format("yyyy-MM-dd")}'
  and substr(confirm_time,1,10) >= '2023-07-17' and substr(confirm_time,1,10) <= '${zdt.addDay(-1).format("yyyy-MM-dd")}'
) a
on a.trans_id = b.trans_id
left outer join
( -- 订单渠道表，含前端传送后端落库的bcp参数
  select distinct order_id, concat(bid,'-',cid,'-',pid) as bcp
  from ods_ccardibuinsprocesssindb.ods_sale_order_channel_record
  where d = '${zdt.addDay(0).format("yyyy-MM-dd")}'
) g
on a.order_id = g.order_id
left outer join
( -- 交易表，含订单的下单locale/region
  select distinct
    trans_id, order_id, uid, pay_total_premium, pay_currency, pay_total_levy, locale, locale_city_code, ip, booking_time, datachange_createtime, datachange_lasttime
  from ods_ccardibuinsprocesssindb.ods_sale_transaction_info
  where d = '${zdt.addDay(0).format("yyyy-MM-dd")}'
  and substr(booking_time,1,10) >= '2023-07-17' and substr(booking_time,1,10) <= '${zdt.addDay(-1).format("yyyy-MM-dd")}'
) e
on a.order_id = e.order_id and e.trans_id = a.trans_id
left outer join
( -- 保险平台结算表，含准确佣金
  select *
  from dw_finance_ibuins_db.edw_ins_transdata
  where d = '${zdt.addDay(0).format("yyyy-MM-dd")}'
  and substr(transtime,1,10) >= '2023-07-17' and substr(transtime,1,10) <= '${zdt.addDay(-1).format("yyyy-MM-dd")}'
  and settlementitemid = 107 and insurancetype = 0
) c
on b.policy_no = c.policyno

)

insert overwrite table dw_finance_ibuins_db.edw_ins_ind_transdata
partition (d = '${zdt.addDay(0).format("yyyy-MM-dd")}')

select *
from
(
	-- 【出保】
	select * from policy_insure
	
	union all
	-- 【退保】
	select 
	  a.apply_id,a.trans_id,a.uid,a.order_id,a.settlementitemid,a.locale,a.region,1 as insurancetype,'退保' as insurancetype_name,a.policyno,a.companyid,a.companyname,a.productcode,a.productname
	  ,b.currency as currency
	  ,coalesce(c.premium+a.levy,-1*a.premium) as premium
	  ,-1*a.levy as levy
	  ,coalesce(c.commission,-1*a.commission) as commission
	  ,coalesce(c.servicefee,-1*a.servicefee) as servicefee
	  ,b.refund_time as transtime,a.effectivetime,a.expirytime,a.policy_url,a.departure,a.departuretime,a.arrivaltime,a.ordertime,a.etd,a.policy_datachange_createtime,a.policy_datachange_lasttime
	  ,coalesce(c.premium,-1*a.pay_premium) as pay_premium
	  ,a.bcp
	from policy_insure a
	inner join
	( -- 退保表
	  select distinct
	     order_id, refund_trans_id, refund_status, refund_amount, currency, refund_time, refund_reason
	  from ods_ccardibuinsprocesssindb.ods_sale_refund_info
	  where d = '${zdt.addDay(0).format("yyyy-MM-dd")}'
	  and substr(refund_time,1,10) >= '2023-07-17' and substr(refund_time,1,10) <= '${zdt.addDay(-1).format("yyyy-MM-dd")}' and refund_status = 2 -- 退款成功
	) b
	on a.order_id = b.order_id
	left outer join
	( -- 保险平台结算表，含准确佣金
	  select *
	  from dw_finance_ibuins_db.edw_ins_transdata
	  where d = '${zdt.addDay(0).format("yyyy-MM-dd")}'
	  and substr(transtime,1,10) >= '2023-07-17' and substr(transtime,1,10) <= '${zdt.addDay(-1).format("yyyy-MM-dd")}'
	  and settlementitemid = 107 and insurancetype = 1
	) c
	on a.policyno = c.policyno
) t

where t.order_id not in (
  '23879268156','23879268140','23879268121','23879268120','23879268117','23879268057' 			  --- AXA香港智悠游
  ,'23879274001','23879274192','23879273986','23879274609','23879274789','23879278135','23879285052','23879286090' --- Chubb泰国
  ) -- 测试订单
;



